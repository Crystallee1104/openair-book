<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 19 Conditional quantiles | The openair book</title>
  <meta name="description" content="Analysing air quality data with the openair package" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 19 Conditional quantiles | The openair book" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="images/cover.png" />
  <meta property="og:description" content="Analysing air quality data with the openair package" />
  <meta name="github-repo" content="davidcarslaw/openair-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 19 Conditional quantiles | The openair book" />
  
  <meta name="twitter:description" content="Analysing air quality data with the openair package" />
  <meta name="twitter:image" content="images/cover.png" />

<meta name="author" content="David C. Carslaw" />


<meta name="date" content="2020-07-31" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="sec-trajPlot.html"/>
<link rel="next" href="sec-modStats.html"/>
<script src="libs/header-attrs-2.3/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
<link href="libs/leaflet-markercluster-1.0.5/MarkerCluster.css" rel="stylesheet" />
<link href="libs/leaflet-markercluster-1.0.5/MarkerCluster.Default.css" rel="stylesheet" />
<script src="libs/leaflet-markercluster-1.0.5/leaflet.markercluster.js"></script>
<script src="libs/leaflet-markercluster-1.0.5/leaflet.markercluster.freezable.js"></script>
<script src="libs/leaflet-markercluster-1.0.5/leaflet.markercluster.layersupport.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The openair book</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#hello-and-welcome"><i class="fa fa-check"></i>Hello and welcome</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="sec-openair-package.html"><a href="sec-openair-package.html"><i class="fa fa-check"></i><b>2</b> The openair package</a>
<ul>
<li class="chapter" data-level="2.1" data-path="sec-openair-package.html"><a href="sec-openair-package.html#installation-and-code-access"><i class="fa fa-check"></i><b>2.1</b> Installation and code access</a></li>
<li class="chapter" data-level="2.2" data-path="sec-openair-package.html"><a href="sec-openair-package.html#input-data-requirements"><i class="fa fa-check"></i><b>2.2</b> Input data requirements</a></li>
<li class="chapter" data-level="2.3" data-path="sec-openair-package.html"><a href="sec-openair-package.html#sec:brief-intr-open"><i class="fa fa-check"></i><b>2.3</b> Brief overview of openair</a></li>
<li class="chapter" data-level="2.4" data-path="sec-openair-package.html"><a href="sec-openair-package.html#the-type-option"><i class="fa fa-check"></i><b>2.4</b> The type option</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="sec-openair-package.html"><a href="sec-openair-package.html#make-your-own-type"><i class="fa fa-check"></i><b>2.4.1</b> Make your own type</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="sec-openair-package.html"><a href="sec-openair-package.html#sec:font-size"><i class="fa fa-check"></i><b>2.5</b> Controlling font size</a></li>
<li class="chapter" data-level="2.6" data-path="sec-openair-package.html"><a href="sec-openair-package.html#sec:colours"><i class="fa fa-check"></i><b>2.6</b> Using colours</a></li>
<li class="chapter" data-level="2.7" data-path="sec-openair-package.html"><a href="sec-openair-package.html#sec:quickText"><i class="fa fa-check"></i><b>2.7</b> Automatic text formatting</a></li>
<li class="chapter" data-level="2.8" data-path="sec-openair-package.html"><a href="sec-openair-package.html#sec:multiple-plots-page"><i class="fa fa-check"></i><b>2.8</b> Multiple plots on a page</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sec-importAURN.html"><a href="sec-importAURN.html"><i class="fa fa-check"></i><b>3</b> Accessing UK Air Quality Data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="sec-importAURN.html"><a href="sec-importAURN.html#accessing-data"><i class="fa fa-check"></i><b>3.1</b> Accessing data</a></li>
<li class="chapter" data-level="3.2" data-path="sec-importAURN.html"><a href="sec-importAURN.html#site-meta-data"><i class="fa fa-check"></i><b>3.2</b> Site Meta Data</a></li>
<li class="chapter" data-level="3.3" data-path="sec-importAURN.html"><a href="sec-importAURN.html#plot-sites-on-a-map"><i class="fa fa-check"></i><b>3.3</b> Plot Sites on a Map</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="sec-worldmet.html"><a href="sec-worldmet.html"><i class="fa fa-check"></i><b>4</b> Access meteorological data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="sec-worldmet.html"><a href="sec-worldmet.html#the-worldmet-package"><i class="fa fa-check"></i><b>4.1</b> The worldmet package</a></li>
<li class="chapter" data-level="4.2" data-path="sec-worldmet.html"><a href="sec-worldmet.html#sec:link-aq"><i class="fa fa-check"></i><b>4.2</b> Linking with air quality data</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="sec-windRose.html"><a href="sec-windRose.html"><i class="fa fa-check"></i><b>5</b> Wind and Pollution Roses</a>
<ul>
<li class="chapter" data-level="5.1" data-path="sec-windRose.html"><a href="sec-windRose.html#example-of-use"><i class="fa fa-check"></i><b>5.1</b> Example of use</a></li>
<li class="chapter" data-level="5.2" data-path="sec-windRose.html"><a href="sec-windRose.html#sec:comp-met"><i class="fa fa-check"></i><b>5.2</b> Comparing two meteorological data sets</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="sec-polarFreq.html"><a href="sec-polarFreq.html"><i class="fa fa-check"></i><b>6</b> Polar frequencies</a>
<ul>
<li class="chapter" data-level="6.1" data-path="sec-polarFreq.html"><a href="sec-polarFreq.html#sec:polarFreqBack"><i class="fa fa-check"></i><b>6.1</b> Background and examples</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="sec-percentileRose.html"><a href="sec-percentileRose.html"><i class="fa fa-check"></i><b>7</b> Percentile roses</a>
<ul>
<li class="chapter" data-level="7.1" data-path="sec-percentileRose.html"><a href="sec-percentileRose.html#introduction"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="sec-percentileRose.html"><a href="sec-percentileRose.html#examples"><i class="fa fa-check"></i><b>7.2</b> Examples</a></li>
<li class="chapter" data-level="7.3" data-path="sec-percentileRose.html"><a href="sec-percentileRose.html#sec:CPF"><i class="fa fa-check"></i><b>7.3</b> Condtional probability function</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="sec-polarPlot.html"><a href="sec-polarPlot.html"><i class="fa fa-check"></i><b>8</b> Polar plots</a>
<ul>
<li class="chapter" data-level="8.1" data-path="sec-polarPlot.html"><a href="sec-polarPlot.html#introduction-to-polar-plots"><i class="fa fa-check"></i><b>8.1</b> Introduction to polar plots</a></li>
<li class="chapter" data-level="8.2" data-path="sec-polarPlot.html"><a href="sec-polarPlot.html#polar-plot-examples"><i class="fa fa-check"></i><b>8.2</b> Examples</a></li>
<li class="chapter" data-level="8.3" data-path="sec-polarPlot.html"><a href="sec-polarPlot.html#nonparametric-wind-regression-nwr"><i class="fa fa-check"></i><b>8.3</b> Nonparametric Wind Regression, NWR</a></li>
<li class="chapter" data-level="8.4" data-path="sec-polarPlot.html"><a href="sec-polarPlot.html#conditional-probability-function-cpf-plot"><i class="fa fa-check"></i><b>8.4</b> Conditional Probability Function (CPF) plot</a></li>
<li class="chapter" data-level="8.5" data-path="sec-polarPlot.html"><a href="sec-polarPlot.html#pairwise-statistics"><i class="fa fa-check"></i><b>8.5</b> Pairwise statistics</a></li>
<li class="chapter" data-level="8.6" data-path="sec-polarPlot.html"><a href="sec-polarPlot.html#sec:polarCluster"><i class="fa fa-check"></i><b>8.6</b> Clustering</a></li>
<li class="chapter" data-level="8.7" data-path="sec-polarPlot.html"><a href="sec-polarPlot.html#polar-plots-on-an-interactive-map"><i class="fa fa-check"></i><b>8.7</b> Polar plots on an interactive map</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="sec-polarAnnulus.html"><a href="sec-polarAnnulus.html"><i class="fa fa-check"></i><b>9</b> Polar annulus</a>
<ul>
<li class="chapter" data-level="9.1" data-path="sec-polarAnnulus.html"><a href="sec-polarAnnulus.html#polarAnnulusBack"><i class="fa fa-check"></i><b>9.1</b> Purpose</a></li>
<li class="chapter" data-level="9.2" data-path="sec-polarAnnulus.html"><a href="sec-polarAnnulus.html#sec:examAnnulus"><i class="fa fa-check"></i><b>9.2</b> Example of use</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="sec-timePlot.html"><a href="sec-timePlot.html"><i class="fa fa-check"></i><b>10</b> Time series plots</a>
<ul>
<li class="chapter" data-level="10.1" data-path="sec-timePlot.html"><a href="sec-timePlot.html#sec:timePlotBack"><i class="fa fa-check"></i><b>10.1</b> Background</a></li>
<li class="chapter" data-level="10.2" data-path="sec-timePlot.html"><a href="sec-timePlot.html#examples-of-time-series-plotting"><i class="fa fa-check"></i><b>10.2</b> Examples of time series plotting</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="sec-timeVariation.html"><a href="sec-timeVariation.html"><i class="fa fa-check"></i><b>11</b> Temporal variations</a>
<ul>
<li class="chapter" data-level="11.1" data-path="sec-timeVariation.html"><a href="sec-timeVariation.html#sec:purpose-time-var"><i class="fa fa-check"></i><b>11.1</b> Purpose</a></li>
<li class="chapter" data-level="11.2" data-path="sec-timeVariation.html"><a href="sec-timeVariation.html#applications"><i class="fa fa-check"></i><b>11.2</b> Applications</a></li>
<li class="chapter" data-level="11.3" data-path="sec-timeVariation.html"><a href="sec-timeVariation.html#output"><i class="fa fa-check"></i><b>11.3</b> Output</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="sec-timeProp.html"><a href="sec-timeProp.html"><i class="fa fa-check"></i><b>12</b> Time proportion plots</a>
<ul>
<li class="chapter" data-level="12.1" data-path="sec-timeProp.html"><a href="sec-timeProp.html#sec:timePropBack"><i class="fa fa-check"></i><b>12.1</b> Background</a></li>
<li class="chapter" data-level="12.2" data-path="sec-timeProp.html"><a href="sec-timeProp.html#sec:timePropEx"><i class="fa fa-check"></i><b>12.2</b> Examples</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="sec-trendLevel.html"><a href="sec-trendLevel.html"><i class="fa fa-check"></i><b>13</b> Trend heat maps</a>
<ul>
<li class="chapter" data-level="13.1" data-path="sec-trendLevel.html"><a href="sec-trendLevel.html#another-way-of-representing-trends"><i class="fa fa-check"></i><b>13.1</b> Another way of representing trends</a></li>
<li class="chapter" data-level="13.2" data-path="sec-trendLevel.html"><a href="sec-trendLevel.html#sec:TrendLevelEx"><i class="fa fa-check"></i><b>13.2</b> Examples</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="sec-calendarPlot.html"><a href="sec-calendarPlot.html"><i class="fa fa-check"></i><b>14</b> Calendar plots</a>
<ul>
<li class="chapter" data-level="14.1" data-path="sec-calendarPlot.html"><a href="sec-calendarPlot.html#purpose"><i class="fa fa-check"></i><b>14.1</b> Purpose</a></li>
<li class="chapter" data-level="14.2" data-path="sec-calendarPlot.html"><a href="sec-calendarPlot.html#calendar-examples"><i class="fa fa-check"></i><b>14.2</b> Calendar examples</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="sec-TheilSen.html"><a href="sec-TheilSen.html"><i class="fa fa-check"></i><b>15</b> Theil-Sen trends</a>
<ul>
<li class="chapter" data-level="15.1" data-path="sec-TheilSen.html"><a href="sec-TheilSen.html#trend-estimates"><i class="fa fa-check"></i><b>15.1</b> Trend estimates</a></li>
<li class="chapter" data-level="15.2" data-path="sec-TheilSen.html"><a href="sec-TheilSen.html#example-trend-analysis"><i class="fa fa-check"></i><b>15.2</b> Example trend analysis</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="sec-timeVariation.html"><a href="sec-timeVariation.html#output"><i class="fa fa-check"></i><b>15.2.1</b> Output</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="sec-smoothTrend.html"><a href="sec-smoothTrend.html"><i class="fa fa-check"></i><b>16</b> Smooth trends</a>
<ul>
<li class="chapter" data-level="16.1" data-path="sec-smoothTrend.html"><a href="sec-smoothTrend.html#sec:SmoothTrendInfo"><i class="fa fa-check"></i><b>16.1</b> Background</a></li>
<li class="chapter" data-level="16.2" data-path="sec-smoothTrend.html"><a href="sec-smoothTrend.html#examples-of-trend-analysis"><i class="fa fa-check"></i><b>16.2</b> Examples of trend analysis</a></li>
<li class="chapter" data-level="16.3" data-path="sec-smoothTrend.html"><a href="sec-smoothTrend.html#seasonal-averages"><i class="fa fa-check"></i><b>16.3</b> Seasonal averages</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="sec-scatterPlot.html"><a href="sec-scatterPlot.html"><i class="fa fa-check"></i><b>17</b> Scatter plots</a>
<ul>
<li class="chapter" data-level="17.1" data-path="sec-scatterPlot.html"><a href="sec-scatterPlot.html#sec:ScatterPurpose"><i class="fa fa-check"></i><b>17.1</b> Purpose</a></li>
<li class="chapter" data-level="17.2" data-path="sec-scatterPlot.html"><a href="sec-scatterPlot.html#sec:ScatterEx"><i class="fa fa-check"></i><b>17.2</b> Examples</a>
<ul>
<li class="chapter" data-level="17.2.1" data-path="sec-scatterPlot.html"><a href="sec-scatterPlot.html#sec:hexbin"><i class="fa fa-check"></i><b>17.2.1</b> Hexaganol binning</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="18" data-path="sec-trajPlot.html"><a href="sec-trajPlot.html"><i class="fa fa-check"></i><b>18</b> Trajectory analysis</a>
<ul>
<li class="chapter" data-level="18.1" data-path="sec-trajPlot.html"><a href="sec-trajPlot.html#plotting-trajectories"><i class="fa fa-check"></i><b>18.1</b> Plotting trajectories</a></li>
<li class="chapter" data-level="18.2" data-path="sec-trajPlot.html"><a href="sec-trajPlot.html#sec:trajLevel"><i class="fa fa-check"></i><b>18.2</b> Trajectory gridded frequencies</a></li>
<li class="chapter" data-level="18.3" data-path="sec-trajPlot.html"><a href="sec-trajPlot.html#trajectory-source-contribution-functions"><i class="fa fa-check"></i><b>18.3</b> Trajectory source contribution functions</a>
<ul>
<li class="chapter" data-level="18.3.1" data-path="sec-trajPlot.html"><a href="sec-trajPlot.html#identifying-the-contribution-of-high-concentration-back-trajectories"><i class="fa fa-check"></i><b>18.3.1</b> Identifying the contribution of high concentration back trajectories</a></li>
<li class="chapter" data-level="18.3.2" data-path="sec-trajPlot.html"><a href="sec-trajPlot.html#allocating-trajectories-to-different-wind-sectors"><i class="fa fa-check"></i><b>18.3.2</b> Allocating trajectories to different wind sectors</a></li>
</ul></li>
<li class="chapter" data-level="18.4" data-path="sec-trajPlot.html"><a href="sec-trajPlot.html#potential-source-contribution-function-pscf"><i class="fa fa-check"></i><b>18.4</b> Potential Source Contribution Function (PSCF)</a></li>
<li class="chapter" data-level="18.5" data-path="sec-trajPlot.html"><a href="sec-trajPlot.html#concentration-weighted-trajectory-cwt"><i class="fa fa-check"></i><b>18.5</b> Concentration Weighted Trajectory (CWT)</a></li>
<li class="chapter" data-level="18.6" data-path="sec-trajPlot.html"><a href="sec-trajPlot.html#sec:trajCluster"><i class="fa fa-check"></i><b>18.6</b> Trajectory clustering</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="sec-conditionalQuantile.html"><a href="sec-conditionalQuantile.html"><i class="fa fa-check"></i><b>19</b> Conditional quantiles</a>
<ul>
<li class="chapter" data-level="19.1" data-path="sec-conditionalQuantile.html"><a href="sec-conditionalQuantile.html#sec:conditionalQuantileBack"><i class="fa fa-check"></i><b>19.1</b> Background</a></li>
<li class="chapter" data-level="19.2" data-path="sec-conditionalQuantile.html"><a href="sec-conditionalQuantile.html#sec:conditionalEval"><i class="fa fa-check"></i><b>19.2</b> Conditional evaluation</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="sec-modStats.html"><a href="sec-modStats.html"><i class="fa fa-check"></i><b>20</b> Model evaluation</a>
<ul>
<li class="chapter" data-level="20.1" data-path="sec-modStats.html"><a href="sec-modStats.html#sec:ModBack"><i class="fa fa-check"></i><b>20.1</b> Background</a></li>
<li class="chapter" data-level="20.2" data-path="sec-modStats.html"><a href="sec-modStats.html#sec:ModEx"><i class="fa fa-check"></i><b>20.2</b> Example of use</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="sec-TaylorDiagram.html"><a href="sec-TaylorDiagram.html"><i class="fa fa-check"></i><b>21</b> Taylor Diagam</a>
<ul>
<li class="chapter" data-level="21.1" data-path="sec-TaylorDiagram.html"><a href="sec-TaylorDiagram.html#sec:TaylorBack"><i class="fa fa-check"></i><b>21.1</b> Background</a></li>
<li class="chapter" data-level="21.2" data-path="sec-TaylorDiagram.html"><a href="sec-TaylorDiagram.html#examples-of-taylor-diagrams"><i class="fa fa-check"></i><b>21.2</b> Examples of Taylor Diagrams</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="sec-utility.html"><a href="sec-utility.html"><i class="fa fa-check"></i><b>22</b> Utility functions</a>
<ul>
<li class="chapter" data-level="22.1" data-path="sec-utility.html"><a href="sec-utility.html#sec:selectByDate"><i class="fa fa-check"></i><b>22.1</b> Selecting data by date</a></li>
<li class="chapter" data-level="22.2" data-path="sec-utility.html"><a href="sec-utility.html#sec:cutData"><i class="fa fa-check"></i><b>22.2</b> Making intervals — cutData</a></li>
<li class="chapter" data-level="22.3" data-path="sec-utility.html"><a href="sec-utility.html#sec:selectRunning"><i class="fa fa-check"></i><b>22.3</b> Selecting run lengths of values above a threshold — pollution episodes</a></li>
<li class="chapter" data-level="22.4" data-path="sec-utility.html"><a href="sec-utility.html#sec:rollingMean"><i class="fa fa-check"></i><b>22.4</b> Calculating rolling means</a></li>
<li class="chapter" data-level="22.5" data-path="sec-utility.html"><a href="sec-utility.html#sec:timeAverage"><i class="fa fa-check"></i><b>22.5</b> Aggregating data by different time intervals</a></li>
<li class="chapter" data-level="22.6" data-path="sec-utility.html"><a href="sec-utility.html#sec:calcPercentile"><i class="fa fa-check"></i><b>22.6</b> Calculating percentiles</a></li>
<li class="chapter" data-level="22.7" data-path="sec-utility.html"><a href="sec-utility.html#sec:corPlot"><i class="fa fa-check"></i><b>22.7</b> Correlation matrices</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="annotating-openair-plots.html"><a href="annotating-openair-plots.html"><i class="fa fa-check"></i><b>A</b> Annotating openair plots</a>
<ul>
<li class="chapter" data-level="A.1" data-path="annotating-openair-plots.html"><a href="annotating-openair-plots.html#adding-text"><i class="fa fa-check"></i><b>A.1</b> Adding text</a></li>
<li class="chapter" data-level="A.2" data-path="annotating-openair-plots.html"><a href="annotating-openair-plots.html#adding-text-and-a-shaded-area"><i class="fa fa-check"></i><b>A.2</b> Adding text and a shaded area</a></li>
<li class="chapter" data-level="A.3" data-path="annotating-openair-plots.html"><a href="annotating-openair-plots.html#adding-an-arrow"><i class="fa fa-check"></i><b>A.3</b> Adding an arrow</a></li>
<li class="chapter" data-level="A.4" data-path="annotating-openair-plots.html"><a href="annotating-openair-plots.html#adding-a-reference-line-and-text"><i class="fa fa-check"></i><b>A.4</b> Adding a reference line and text</a></li>
<li class="chapter" data-level="A.5" data-path="annotating-openair-plots.html"><a href="annotating-openair-plots.html#highlight-a-specific-point"><i class="fa fa-check"></i><b>A.5</b> Highlight a specific point</a></li>
<li class="chapter" data-level="A.6" data-path="annotating-openair-plots.html"><a href="annotating-openair-plots.html#add-a-filled-polygon"><i class="fa fa-check"></i><b>A.6</b> Add a filled polygon</a></li>
<li class="chapter" data-level="A.7" data-path="annotating-openair-plots.html"><a href="annotating-openair-plots.html#add-air-quality-bands-as-polygons"><i class="fa fa-check"></i><b>A.7</b> Add air quality bands as polygons</a></li>
<li class="chapter" data-level="A.8" data-path="sec-polarPlot.html"><a href="sec-polarPlot.html#polar-plot-examples"><i class="fa fa-check"></i><b>A.8</b> Polar plot examples</a></li>
<li class="chapter" data-level="A.9" data-path="annotating-openair-plots.html"><a href="annotating-openair-plots.html#using-grid-graphics-identify-locations-interactively"><i class="fa fa-check"></i><b>A.9</b> Using grid graphics — identify locations interactively</a></li>
</ul></li>
<li class="chapter" data-level="B" data-path="sec-prod-hyspl-traj.html"><a href="sec-prod-hyspl-traj.html"><i class="fa fa-check"></i><b>B</b> Production of HYSPLIT trajectory files</a></li>
<li class="chapter" data-level="C" data-path="sec-trends-gam.html"><a href="sec-trends-gam.html"><i class="fa fa-check"></i><b>C</b> A closer look at trends</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The openair book</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sec:conditionalQuantile" class="section level1" number="19">
<h1><span class="header-section-number">Section 19</span> Conditional quantiles</h1>
<div id="sec:conditionalQuantileBack" class="section level2" number="19.1">
<h2><span class="header-section-number">19.1</span> Background</h2>
<p>Conditional quantiles are a very useful way of considering model
performance against observations for continuous measurements
<span class="citation">(Wilks <a href="#ref-Wilks2005" role="doc-biblioref">2005</a>)</span>. The conditional quantile plot splits the data into
evenly spaced bins. For each predicted value bin e.g. from 0 to 10 ppb
the <em>corresponding</em> values of the observations are identified and
the median, 25/75th and 10/90 percentile (quantile) calculated for
that bin. The data are plotted to show how these values vary across
all bins. For a time series of observations and predictions that agree
precisely the median value of the predictions will equal that for the
observations for each bin.</p>
<p>The conditional quantile plot differs from the quantile-quantile plot
(Q-Q plot) that is often used to compare observations and
predictions. A Q-Q~plot separately considers the distributions of
observations and predictions, whereas the conditional quantile uses
the corresponding observations for a particular interval in the
predictions. Take as an example two time series, the first a series of
real observations and the second a lagged time series of the same
observations representing the predictions. These two time series will
have identical (or very nearly identical) distributions (e.g. same
median, minimum and maximum). A Q-Q plot would show a straight line
showing perfect agreement, whereas the conditional quantile will
not. This is because in any interval of the predictions the
corresponding observations now have different values.</p>
<p>Plotting the data in this way shows how well predictions agree with
observations and can help reveal many useful characteristics of how
well model predictions agree with observations — across the full
distribution of values. A single plot can therefore convey a
considerable amount of information concerning model performance. The
basic function is considerably enhanced by allowing flexible
conditioning easily e.g. to evaluate model performance by season, day
of the week and so on, as in other <span class="pkg">openair</span> functions.</p>
<p>To make things more interesting we will use data from a model
evaluation exercise organised by Defra in 2010/2011. Many models were
evaluated but we only consider hourly ozone predictions from the CMAQ
model being used at King’s College London.</p>
<p>First the data are loaded:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="sec-conditionalQuantile.html#cb222-1" aria-hidden="true"></a><span class="kw">load</span>(<span class="st">&quot;~/My Drive/openair/Data/CMAQozone.RData&quot;</span>)</span>
<span id="cb222-2"><a href="sec-conditionalQuantile.html#cb222-2" aria-hidden="true"></a><span class="kw">class</span>(CMAQ.KCL<span class="op">$</span>date) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;POSIXct&quot;</span>, <span class="st">&quot;POSIXt&quot;</span>)</span>
<span id="cb222-3"><a href="sec-conditionalQuantile.html#cb222-3" aria-hidden="true"></a><span class="kw">head</span>(CMAQ.KCL)</span></code></pre></div>
<pre><code>##         site                date o3 rollingO3Meas   mod rollingO3Mod    group
## 1 Aston.Hill 2006-01-01 00:00:00 NA            NA 92.80           NA CMAQ.KCL
## 2 Aston.Hill 2006-01-01 01:00:00 74            NA 92.18           NA CMAQ.KCL
## 3 Aston.Hill 2006-01-01 02:00:00 72            NA 92.14           NA CMAQ.KCL
## 4 Aston.Hill 2006-01-01 03:00:00 72            NA 91.72           NA CMAQ.KCL
## 5 Aston.Hill 2006-01-01 04:00:00 70            NA 91.50           NA CMAQ.KCL
## 6 Aston.Hill 2006-01-01 05:00:00 66            NA 92.28           NA CMAQ.KCL</code></pre>
<p>The data consists of hourly observations of O<sub>3</sub> in μg m<sup>-3</sup> at 15 rural
O<sub>3</sub> sites in the UK together with predicted values.<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a> First, we consider O<sub>3</sub> predictions across all sites to
help illustrate the purpose of the function. The results are shown in Figure <a href="sec-conditionalQuantile.html#fig:conditionaQ1">19.1</a>. An explanation of the Figure is given in its caption.</p>

<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="sec-conditionalQuantile.html#cb224-1" aria-hidden="true"></a><span class="kw">conditionalQuantile</span>(CMAQ.KCL, <span class="dt">obs =</span> <span class="st">&quot;o3&quot;</span>, <span class="dt">mod =</span> <span class="st">&quot;mod&quot;</span>)</span></code></pre></div>
<div class="figure"><span id="fig:conditionaQ1"></span>
<img src="openair_files/figure-html/conditionaQ1-1.png" alt="Example of the use of conditional quantiles applied to the KCL CMAQ model for 15 rural O3 monitoring sites in 2006, for hourly data. The blue line shows the results for a perfect model. In this case the observations cover a range from 0 to 270 μg m-3. The red line shows the median values of the predictions and corresponding observations. The maximum predicted value is 125 μg m-3, somewhat less than the maximum observed value. The shading shows the predicted quantile intervals i.e. the 25/75th and the 10/90th. A perfect model would lie on the blue line and have a very narrow spread. There is still some spread because even for a perfect model a specific quantile interval will contain a range of values. However, for the number of bins used in this plot the spread will be very narrow. Finally, the histogram shows the counts of predicted values." width="50%" />
<p class="caption">
Figure 19.1: Example of the use of conditional quantiles applied to the KCL CMAQ model for 15 rural O<sub>3</sub> monitoring sites in 2006, for hourly data. The blue line shows the results for a perfect model. In this case the observations cover a range from 0 to 270 μg m<sup>-3</sup>. The red line shows the median values of the predictions and corresponding observations. The maximum predicted value is 125 μg m<sup>-3</sup>, somewhat less than the maximum observed value. The shading shows the predicted quantile intervals i.e. the 25/75th and the 10/90th. A perfect model would lie on the blue line and have a very narrow spread. There is still some spread because even for a perfect model a specific quantile interval will contain a range of values. However, for the number of bins used in this plot the spread will be very narrow. Finally, the histogram shows the counts of predicted values.
</p>
</div>
<p>A more informative analysis can be undertaken by considering
conditional quantiles separately by site, which is easily done using
the <code>type</code> option. The results are shown in Figure
<a href="sec-conditionalQuantile.html#fig:condQall">19.2</a>. It is now easier to see where the model
performs best and how it varies by site type. For example, at a remote
site in Scotland like Strath Vaich it is clear that the model does not
capture either the lowest or highest O<sub>3</sub> concentrations very well.</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="sec-conditionalQuantile.html#cb225-1" aria-hidden="true"></a><span class="kw">conditionalQuantile</span>(CMAQ.KCL, <span class="dt">obs =</span> <span class="st">&quot;o3&quot;</span>, <span class="dt">mod =</span> <span class="st">&quot;mod&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;site&quot;</span>)</span></code></pre></div>
<div class="figure"><span id="fig:condQall"></span>
<img src="openair_files/figure-html/condQall-1.png" alt="Conditional quantiles by site for 15 O~3~ monitoring sites in the UK." width="1152" />
<p class="caption">
Figure 19.2: Conditional quantiles by site for 15 O<sub>3</sub> monitoring sites in the UK.
</p>
</div>
<p>As with other <span class="pkg">openair</span> functions, the ability to consider conditioning
can really help with interpretation. For example, what do the
conditional quantiles at Lullington Heath (in south-east England) look
like by season? This is easily done by subsetting the data to select
that site and setting <code>type = "season"</code>, as shown in Figure
<a href="sec-conditionalQuantile.html#fig:conditionalSeas">19.3</a>. These results show that winter
predictions have good coverage i.e. with width of the blue `perfect
model’ line is the same as the observations. However, the predictions
tend to be somewhat lower than observations for most concentrations
(the median line is below the blue line) — and the width of the
10/75th and 10/90th percentiles is quite broad. However, the area
where the model is less good is in summer and autumn because the
predictions have low coverage (the red line only covers less than half
of the observation line and the width of the percentiles is wide).</p>
<p>Of course, it is also easy to plot by hour of the day, day of the week,
by daylight/nighttime and so on — easily. All these approaches can
help better understand <em>why</em> a model does not perform very well
rather than just quantifying its performance. Also, these types of
analysis are particularly useful when more than one model is involved
in a comparison as in the recent Defra model evaluation exercise,
which we will come back to later when some results are
published.</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="sec-conditionalQuantile.html#cb226-1" aria-hidden="true"></a><span class="kw">conditionalQuantile</span>(<span class="kw">subset</span>(CMAQ.KCL, site <span class="op">==</span><span class="st"> &quot;Lullington.Heath&quot;</span>), </span>
<span id="cb226-2"><a href="sec-conditionalQuantile.html#cb226-2" aria-hidden="true"></a>                    <span class="dt">obs =</span> <span class="st">&quot;o3&quot;</span>,</span>
<span id="cb226-3"><a href="sec-conditionalQuantile.html#cb226-3" aria-hidden="true"></a>                    <span class="dt">mod =</span> <span class="st">&quot;mod&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;season&quot;</span>)</span></code></pre></div>
<div class="figure"><span id="fig:conditionalSeas"></span>
<img src="openair_files/figure-html/conditionalSeas-1.png" alt="Conditional quantiles at Lullington Heath conditioned by season." width="75%" />
<p class="caption">
Figure 19.3: Conditional quantiles at Lullington Heath conditioned by season.
</p>
</div>
</div>
<div id="sec:conditionalEval" class="section level2" number="19.2">
<h2><span class="header-section-number">19.2</span> Conditional evaluation</h2>
<p>There are numerous ways in which model performance can be assessed,
including the use of common statistical measures described in Section
<a href="sec-modStats.html#sec:modStats">20</a>. These approaches are very useful for comparing
models against observations and other models. However, model
developers would generally like to know <em>why</em> a model may have
poor performance under some situations. This is a much more
challenging issue to address. However, useful information can be
gained by considering how other variables vary simultaneously.</p>
<p>The <code>conditionalEval</code> function provides information on how other
variables vary across the <em>same</em> intervals as shown on the
conditional quantile plot. There are two types of variable that can be
considered by setting the value of <code>statistic</code>. First,
<code>statistic</code> can be another variable in the data frame. In this case
the plot will show the different proportions of <code>statistic</code> across
the range of predictions. For example <code>statistic = "season"</code> will
show for each interval of <code>mod</code> the proportion of predictions that
were spring, summer, autumn or winter. This is useful because if model
performance is worse for example at high concentrations of <code>mod</code>
then knowing that these tend to occur during a particular season
etc. can be very helpful when trying to understand <em>why</em> a model
fails. See Section <a href="sec-utility.html#sec:cutData">22.2</a> for more details on the types of
variable that can be <code>statistic</code>. Another example would be
<code>statistic = "ws"</code> (if wind speed were available in the data
frame), which would then split wind speed into four quantiles and plot
the proportions of each. Again, this would help show whether model
performance in predicting concentrations of O<sub>3</sub> for example is
related to low to high wind speed conditions.</p>
<p><code>conditionalEval</code> can also simultaneously plot the model
performance of other observed/predicted variable <em>pairs</em>
according to different model evaluation statistics. These statistics
derive from the Section <a href="sec-modStats.html#sec:modStats">20</a> function and include <em>MB</em>,
<em>NMB</em>, <em>r</em>, <em>COE</em>, <em>MGE</em>, <em>NMGE</em>, <em>RMSE</em>
and <em>FAC2</em>. More than one statistic can be supplied
e.g. <code>statistic = c("NMB", "COE")</code>. Bootstrap samples are taken
from the corresponding values of other variables to be plotted and
their statistics with 95% confidence intervals calculated. In this
case, the model <em>performance</em> of other variables is shown across
the same intervals of <code>mod</code>, rather than just the values of single
variables. In this second case the model would need to provide
observed/predicted pairs of other variables.</p>
<p>For example, a model may provide predictions of NO<sub>x</sub> and wind speed
(for which there are also observations available). The
<code>conditionalEval</code> function will show how well these other variables
are predicted for the <em>same prediction intervals</em> of the main
variable assessed in the conditional quantile plot e.g. ozone. In this
case, values are supplied to <code>var.obs</code> (observed values for other
variables) and <code>var.mod</code> (modelled values for other variables). For
example, to consider how well the model predicts NO<sub>x</sub> and wind speed
<code>var.obs = c("nox.obs", "ws.obs")</code> and <code>var.mod = c("nox.mod",  "ws.mod")</code> would be supplied (assuming <code>nox.obs, nox.mod, ws.obs,  ws.mod</code> are present in the data frame). The analysis could show for
example, when ozone concentrations are under-predicted, the model may
also be shown to over-predict concentrations of NO<sub>x</sub> at the same time,
or under-predict wind speeds. Such information can thus help identify
the underlying causes of poor model performance. For example, an
under-prediction in wind speed could result in higher surface NO<sub>x</sub>
concentrations and lower ozone concentrations. Similarly if wind speed
predictions were good and NO<sub>x</sub> was over predicted it might suggest an
over-estimate of NO<sub>x</sub> emissions. One or more additional variables can
be plotted.</p>
<p>A special case is <code>statistic = "cluster"</code>. In this case a data
frame is provided that contains the cluster calculated by
<code>trajCluster</code> and <code>importTraj</code>. Alternatively users could supply
their own pre-calculated clusters. These calculations can be very
useful in showing whether certain back trajectory clusters are
associated with poor (or good) model performance. Note that in the
case of <code>statistic = "cluster"</code> there will be fewer data points
used in the analysis compared with the ordinary statistics above
because the trajectories are available for every three hours. Also
note that <code>statistic = "cluster"</code> cannot be used together with the
ordinary model evaluation statistics such as <em>MB</em>. The output
will be a bar chart showing the proportion of each interval of
<code>mod</code> by cluster number.</p>
<p>Far more insight can be gained into model performance through
conditioning using <code>type</code>. For example, <code>type = "season"</code> will plot conditional quantiles and the associated model
performance statistics of other variables by each
season. <code>type</code> can also be a factor or character field
e.g. representing different models used.</p>
<p>As an example, similar data to that described above from CMAQ have
been used as an example.</p>
<p>A subset of the data for the North Kensington site can be imported as
shown below.</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="sec-conditionalQuantile.html#cb227-1" aria-hidden="true"></a>condDat &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">url</span>(<span class="st">&quot;https://davidcarslaw.com/data/openair/condDat.rds&quot;</span>))</span></code></pre></div>
<p>The file contains observed and modelled hourly values for O<sub>3</sub>,
NO<sub>x</sub>, wind speed, wind direction, temperature and relative humidity.</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="sec-conditionalQuantile.html#cb228-1" aria-hidden="true"></a><span class="kw">head</span>(condDat)</span></code></pre></div>
<pre><code>##                   date O3.obs  NOx.obs ws.obs wd.obs temp.obs rh.obs O3.mod
## 5  2006-01-01 00:00:00     10 29.43665 4.6296    190      4.9     89  14.80
## 10 2006-01-01 01:00:00     15 17.55393     NA    210      5.1     90  17.46
## 15 2006-01-01 02:00:00     11 19.64817 2.5720    220      4.9     94  18.31
## 20 2006-01-01 03:00:00     11 19.15393 3.6008    270      5.7     91  18.25
## 25 2006-01-01 04:00:00     11 17.03037 3.0864    270      5.0     94  18.08
## 30 2006-01-01 05:00:00     12 15.98325 3.6008    260      5.8     94  14.87
##    NOx.mod ws.mod wd.mod temp.mod rh.mod
## 5    24.00   2.78    224     3.85  93.16
## 10   19.91   2.63    226     3.85  92.77
## 15   18.25   2.52    236     2.85  99.40
## 20   18.33   2.48    253     2.85  99.19
## 25   18.09   2.24    275     3.85  97.49
## 30   21.38   2.43    285     4.85  94.41</code></pre>
<p>The <code>conditionalEval</code> function can be used straightforwardly to
provide information on how predictions depend on another variable in
general. In this case the option <code>statistic</code> can refer to another
variable in the data frame to see how the quality of predictions
depend on values of that variable. For example, in Figure
<a href="sec-conditionalQuantile.html#fig:condDatWS">19.4</a> it can be seen how wind speed varies across the
O<sub>3</sub> prediction intervals. At low predicted concentrations of O<sub>3</sub>
there is a high proportion of low wind speed conditions (0 to 2.57
m s<sup>-1</sup>). When O<sub>3</sub> is predicted to be around 40 ppb the wind speed
tends to be higher — and finally at higher predicted concentrations
of O<sub>3</sub> the wind speed tends to decrease again. The important aspect
of plotting data in this way is that it can directly relate the
prediction performance to values of other variables, which should help
develop a much better idea of the conditions that matter most. The
user can therefore develop a good feel for the types of conditions
where a model performs well or poorly and this might provide clues as
to the underlying reasons for specific model behaviour.</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="sec-conditionalQuantile.html#cb230-1" aria-hidden="true"></a><span class="kw">conditionalEval</span>(condDat, <span class="dt">obs =</span> <span class="st">&quot;O3.obs&quot;</span>, <span class="dt">mod =</span> <span class="st">&quot;O3.mod&quot;</span>,</span>
<span id="cb230-2"><a href="sec-conditionalQuantile.html#cb230-2" aria-hidden="true"></a>                <span class="dt">statistic =</span> <span class="st">&quot;ws.obs&quot;</span>,</span>
<span id="cb230-3"><a href="sec-conditionalQuantile.html#cb230-3" aria-hidden="true"></a>                <span class="dt">col.var =</span> <span class="st">&quot;Set3&quot;</span>)</span></code></pre></div>
<div class="figure"><span id="fig:condDatWS"></span>
<img src="openair_files/figure-html/condDatWS-1.png" alt="Conditional quantiles at for O~3~ concentrations (left plot). On the right is a plot showing how the wind speed varies across the O~3~ prediction intervals." width="1440" />
<p class="caption">
Figure 19.4: Conditional quantiles at for O<sub>3</sub> concentrations (left plot). On the right is a plot showing how the wind speed varies across the O<sub>3</sub> prediction intervals.
</p>
</div>
<p>In an extension to Figure<a href="sec-conditionalQuantile.html#fig:condDatWS">19.4</a> it is possible to derive
information on the simultaneous model performance of other
variables. Figure <a href="sec-conditionalQuantile.html#fig:condDat">19.5</a> shows the conditional quantile plot
for hourly O<sub>3</sub> predictions. This shows among other things that
concentrations of O<sub>3</sub> tend to be under-predicted for concentrations
less than about 20 ppb. The Figure on the right shows the simultaneous
<em>model performance</em> for wind speed and NO<sub>x</sub> for the <em>same</em>
prediction intervals as shown in the conditional quantile plot. The
plot on the right shows that for low concentrations of predicted
O<sub>3</sub> there is a tendency for NO<sub>x</sub> concentrations to be overestimated
(NMB <span class="math inline">\(\approx\)</span> 0.2 to 0.4) and wind speeds to be underestimated
(NMB <span class="math inline">\(\approx\)</span> -0.2 to -0.3). One possible explanation for this behaviour
is that the meteorological model tends to produce wind speeds that are
too low, which would result in higher concentrations of NO<sub>x</sub>, which in
turn would result in lower concentrations of O<sub>3</sub>. Note that it is
possible to include more than one statistic, which would be plotted in
a new panel e.g. <code>statistic = c("NMB", "r")</code>.</p>
<p>In essence the <code>conditionalEval</code> function provides more information
on model performance that can help better diagnose potential
problems. Clearly, there are many other ways in which the results can
be analysed, which will depend on the data available.</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="sec-conditionalQuantile.html#cb231-1" aria-hidden="true"></a><span class="kw">conditionalEval</span>(condDat, <span class="dt">obs =</span> <span class="st">&quot;O3.obs&quot;</span>, <span class="dt">mod =</span> <span class="st">&quot;O3.mod&quot;</span>,</span>
<span id="cb231-2"><a href="sec-conditionalQuantile.html#cb231-2" aria-hidden="true"></a>                <span class="dt">var.obs =</span> <span class="kw">c</span>(<span class="st">&quot;NOx.obs&quot;</span>, <span class="st">&quot;ws.obs&quot;</span>),</span>
<span id="cb231-3"><a href="sec-conditionalQuantile.html#cb231-3" aria-hidden="true"></a>                <span class="dt">var.mod =</span> <span class="kw">c</span>(<span class="st">&quot;NOx.mod&quot;</span>, <span class="st">&quot;ws.mod&quot;</span>),</span>
<span id="cb231-4"><a href="sec-conditionalQuantile.html#cb231-4" aria-hidden="true"></a>                <span class="dt">statistic =</span> <span class="st">&quot;NMB&quot;</span>,</span>
<span id="cb231-5"><a href="sec-conditionalQuantile.html#cb231-5" aria-hidden="true"></a>                <span class="dt">var.names =</span> <span class="kw">c</span>(<span class="st">&quot;nox&quot;</span>, <span class="st">&quot;wind speed&quot;</span>))</span></code></pre></div>
<div class="figure"><span id="fig:condDat"></span>
<img src="openair_files/figure-html/condDat-1.png" alt="Conditional quantiles at for O~3~ concentrations (left plot). On the right is the model performance for wind speed and NO~x~ predictions, which in this case is for the Normalised Mean Bias." width="1440" />
<p class="caption">
Figure 19.5: Conditional quantiles at for O<sub>3</sub> concentrations (left plot). On the right is the model performance for wind speed and NO<sub>x</sub> predictions, which in this case is for the Normalised Mean Bias.
</p>
</div>
<p>A plot using temperature predictions shows that for most of the range
in O<sub>3</sub> predictions there is very little bias in temperature
(although there is some negative bias in temperature for very low
concentration O<sub>3</sub> predictions):</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="sec-conditionalQuantile.html#cb232-1" aria-hidden="true"></a> <span class="kw">conditionalEval</span>(condDat, <span class="dt">obs =</span> <span class="st">&quot;O3.obs&quot;</span>, <span class="dt">mod =</span> <span class="st">&quot;O3.mod&quot;</span>,</span>
<span id="cb232-2"><a href="sec-conditionalQuantile.html#cb232-2" aria-hidden="true"></a>                <span class="dt">var.obs =</span> <span class="kw">c</span>(<span class="st">&quot;temp.obs&quot;</span>, <span class="st">&quot;ws.obs&quot;</span>),</span>
<span id="cb232-3"><a href="sec-conditionalQuantile.html#cb232-3" aria-hidden="true"></a>                <span class="dt">var.mod =</span> <span class="kw">c</span>(<span class="st">&quot;temp.mod&quot;</span>, <span class="st">&quot;ws.mod&quot;</span>),</span>
<span id="cb232-4"><a href="sec-conditionalQuantile.html#cb232-4" aria-hidden="true"></a>                <span class="dt">statistic =</span> <span class="st">&quot;NMB&quot;</span>, <span class="dt">var.names =</span> <span class="kw">c</span>(<span class="st">&quot;temperature&quot;</span>, <span class="st">&quot;wind speed&quot;</span>))</span></code></pre></div>
<p>Finally, (but not shown) it can be very useful to consider model
performance in terms of air mass origin. In the example below,
trajectories are imported, a cluster analysis undertaken and then
evaluated using <code>conditionalEval</code>.</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="sec-conditionalQuantile.html#cb233-1" aria-hidden="true"></a><span class="co">## import trajectories for 2006</span></span>
<span id="cb233-2"><a href="sec-conditionalQuantile.html#cb233-2" aria-hidden="true"></a>traj &lt;-<span class="st"> </span><span class="kw">importTraj</span>(<span class="st">&quot;london&quot;</span>, <span class="dv">2006</span>)</span>
<span id="cb233-3"><a href="sec-conditionalQuantile.html#cb233-3" aria-hidden="true"></a></span>
<span id="cb233-4"><a href="sec-conditionalQuantile.html#cb233-4" aria-hidden="true"></a><span class="co">## carry out a cluster analysis</span></span>
<span id="cb233-5"><a href="sec-conditionalQuantile.html#cb233-5" aria-hidden="true"></a>cl &lt;-<span class="st"> </span><span class="kw">trajCluster</span>(traj, <span class="dt">method =</span> <span class="st">&quot;Angle&quot;</span>, <span class="dt">n.cluster =</span> <span class="dv">5</span>)</span>
<span id="cb233-6"><a href="sec-conditionalQuantile.html#cb233-6" aria-hidden="true"></a></span>
<span id="cb233-7"><a href="sec-conditionalQuantile.html#cb233-7" aria-hidden="true"></a><span class="co">## merge with orginal model eval data</span></span>
<span id="cb233-8"><a href="sec-conditionalQuantile.html#cb233-8" aria-hidden="true"></a>condDat &lt;-<span class="st"> </span><span class="kw">merge</span>(condDat, cl, <span class="dt">by =</span> <span class="st">&quot;date&quot;</span>)</span>
<span id="cb233-9"><a href="sec-conditionalQuantile.html#cb233-9" aria-hidden="true"></a></span>
<span id="cb233-10"><a href="sec-conditionalQuantile.html#cb233-10" aria-hidden="true"></a><span class="co">## plot it</span></span>
<span id="cb233-11"><a href="sec-conditionalQuantile.html#cb233-11" aria-hidden="true"></a><span class="kw">conditionalEval</span>(condDat, <span class="dt">obs =</span> <span class="st">&quot;O3.obs&quot;</span>, <span class="dt">mod =</span> <span class="st">&quot;O3.mod&quot;</span>,</span>
<span id="cb233-12"><a href="sec-conditionalQuantile.html#cb233-12" aria-hidden="true"></a>                <span class="dt">statistic =</span> <span class="st">&quot;cluster&quot;</span>,</span>
<span id="cb233-13"><a href="sec-conditionalQuantile.html#cb233-13" aria-hidden="true"></a>                <span class="dt">col.var =</span> <span class="st">&quot;Set3&quot;</span>)</span></code></pre></div>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-Wilks2005">
<p>Wilks, Daniel S. 2005. <em>Statistical Methods in the Atmospheric Sciences, Volume 91, Second Edition (International Geophysics)</em>. 2nd ed. Hardcover; Academic Press.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="7">
<li id="fn7"><p>We
thank Dr Sean Beevers and Dr Nutthida Kitwiroon for access to these
data.<a href="sec-conditionalQuantile.html#fnref7" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="sec-trajPlot.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="sec-modStats.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/davidcarslaw/openair-book/edit/master/conditional-quantiles.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
